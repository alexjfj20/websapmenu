"use strict";(self["webpackChunkwebsap"]=self["webpackChunkwebsap"]||[]).push([[226],{5226:function(e,o,n){n.d(o,{Dy:function(){return d},rJ:function(){return u}});n(8111),n(2489),n(1701);var r=n(8982);const a="websapDatabase",s=3,t="sharedMenus",c="menuImages";function l(){return new Promise(((e,o)=>{try{console.log("Intentando abrir la base de datos con versión:",s);const n=indexedDB.open(a,s);n.onerror=e=>{console.error("Error al abrir la base de datos:",e.target.error),o("Error al abrir la base de datos: "+e.target.errorCode)},n.onsuccess=n=>{const r=n.target.result;console.log("Base de datos abierta con éxito, versión:",r.version);const a=Array.from(r.objectStoreNames);if(console.log("Almacenes existentes:",a),!a.includes(t))return console.error(`El almacén ${t} no existe en la base de datos`),void o(new Error(`El almacén ${t} no existe en la base de datos`));e(r)},n.onupgradeneeded=e=>{console.log("Actualizando estructura de la base de datos a versión:",e.newVersion);const o=e.target.result;o.objectStoreNames.contains(t)||(console.log("Creando almacén:",t),o.createObjectStore(t,{keyPath:"id"})),o.objectStoreNames.contains(c)||(console.log("Creando almacén:",c),o.createObjectStore(c,{keyPath:"id"}))}}catch(n){console.error("Error crítico en IndexedDB:",n),o(n)}}))}function i(){return Math.random().toString(36).substring(2,10)+Math.random().toString(36).substring(2,10)}async function d(e){try{const n=i(),a=await(0,r.By)(),s=await Promise.all(e.map((async e=>{const o={...e};if(o.isSpecial=Boolean(e.isSpecial),console.log(`[saveMenu] Guardando ${e.name} con isSpecial=${o.isSpecial}`),o.image&&"string"===typeof o.image&&o.image.length>0)try{o.image=await(0,r.w4)(o.image,400,300,.5)}catch(n){console.warn("Error al comprimir imagen:",n),o.image=null}return o}))),c={id:n,items:s,businessInfo:a,createdAt:(new Date).toISOString()};try{const e=JSON.stringify(c).length/1048576;if(console.log(`Tamaño del menú a guardar: ${e.toFixed(2)} MB`),e>50)throw new Error(`El menú es demasiado grande (${e.toFixed(2)} MB). Reduce el tamaño de las imágenes.`)}catch(o){throw console.error("Error al verificar tamaño del menú:",o),new Error("Error al verificar tamaño del menú")}const d=await l(),u=d.transaction([t],"readwrite"),g=u.objectStore(t);return await new Promise(((e,o)=>{const r=g.put(c);r.onsuccess=()=>{console.log(`Menú guardado exitosamente con ID: ${n}`),e()},r.onerror=e=>{console.error("Error al guardar el menú:",e.target.error),o(e.target.error)}})),console.log("[saveMenu] Items a guardar:",e.length),console.log("[saveMenu] Items especiales:",e.filter((e=>e.isSpecial)).length),console.log("[saveMenu] Items regulares:",e.filter((e=>!e.isSpecial)).length),await m(),n}catch(o){throw console.error("Error al guardar el menú compartido:",o),o}}async function u(e){try{if(console.log(`Intentando recuperar menú con ID: ${e}`),!e)return console.error("ID de menú no proporcionado"),null;let l=null;try{const o=await n.e(460).then(n.bind(n,3460)),r=await o.getMenuFromIndexedDB(e);r&&r.items&&r.items.length>0&&(console.log("Menú recuperado desde IndexedDB:",r),l=r)}catch(o){console.warn("No se pudo obtener el menú desde IndexedDB:",o)}if(!l||!l.items||0===l.items.length){console.log(`Obteniendo menú desde el servidor con ID: ${e}`);try{const o=await Promise.resolve().then(n.bind(n,133)),r=await o.default.get(`/platos/menu/${e}`);if(r&&r.success&&r.data)console.log("Menú recuperado desde el servidor:",r.data),l=r.data;else if(console.warn("No se pudo obtener el menú desde el servidor:",r),!l)throw new Error("No se pudo obtener el menú")}catch(a){if(console.error("Error al obtener el menú desde el servidor:",a),!l)try{const o=localStorage.getItem(`menu_${e}`);if(!o)throw new Error("No se encontró el menú en la caché");l=JSON.parse(o),console.log("Menú recuperado desde localStorage:",l)}catch(s){throw console.error("Error al recuperar menú desde la caché:",s),new Error("No se pudo obtener el menú")}}}if(l&&!l.businessInfo)try{const e=await(0,r.By)();l.businessInfo=e}catch(t){console.warn("No se pudo obtener información del negocio:",t),l.businessInfo={name:"Restaurante WebSAP",description:"Deliciosa comida para todos los gustos",contact:"info@websap.com",address:"Calle Principal #123",logo:null,paymentInfo:{qrImage:null,qrTitle:"Escanea para pagar",nequiNumber:null,nequiImage:null,bankInfo:"Banco XYZ - Cuenta 123456789",otherPaymentMethods:"Aceptamos efectivo y tarjetas"}}}l&&l.businessInfo&&!l.businessInfo.paymentInfo&&(l.businessInfo.paymentInfo={qrImage:null,qrTitle:"Escanea para pagar",nequiNumber:null,nequiImage:null,bankInfo:"Banco XYZ - Cuenta 123456789",otherPaymentMethods:"Aceptamos efectivo y tarjetas"});try{localStorage.setItem(`menu_${e}`,JSON.stringify(l))}catch(c){console.warn("No se pudo guardar el menú en localStorage:",c)}console.log("[getSharedMenu] Menú recuperado:",l);const i=l?.items?.filter((e=>e.isSpecial))||[],d=l?.items?.filter((e=>!e.isSpecial))||[];return console.log("[getSharedMenu] Items especiales:",i.length),console.log("[getSharedMenu] Items regulares:",d.length),l}catch(l){throw console.error("Error al obtener el menú compartido:",l),l}}async function m(e){try{if(console.log("Sincronizando información del negocio con el backend:",e),!e||0===Object.keys(e).length)return console.error("No hay información del negocio para sincronizar"),{success:!1,message:"No hay información del negocio para sincronizar"};const o=await Promise.resolve().then(n.bind(n,133)),r=o.default,a=localStorage.getItem("token");a&&r.setToken(a);const s=await r.get("/auth/me");if(!s||!s.success||!s.user||!s.user.restaurante_id)return console.warn("No se pudo obtener el restaurante del usuario actual"),{success:!1,message:"No se pudo obtener el restaurante del usuario actual"};const t=s.user.restaurante_id,c=e.paymentInfo||{qrImage:null,qrTitle:"Escanea para pagar",nequiNumber:null,nequiImage:null,bankInfo:"Banco XYZ - Cuenta 123456789",otherPaymentMethods:"Aceptamos efectivo y tarjetas"},l={nombre:e.name||"",descripcion:e.description||"",direccion:e.address||"",telefono:e.contact||"",logo:e.logo||null,informacion_pago:JSON.stringify(c)};console.log("Datos a enviar al backend:",l);const i=await r.put(`/restaurantes/${t}`,l);return i&&i.success?(console.log("Información del negocio sincronizada con éxito"),{success:!0,message:"Información del negocio sincronizada con éxito"}):(console.warn("Error al sincronizar información del negocio:",i),{success:!1,message:i.message||"Error al sincronizar información del negocio"})}catch(o){return console.error("Error al sincronizar información del negocio:",o),{success:!1,message:o.message||"Error al sincronizar información del negocio"}}}}}]);
//# sourceMappingURL=226.2f25ca18.js.map