"use strict";(self["webpackChunkwebsap"]=self["webpackChunkwebsap"]||[]).push([[70],{2949:function(e,n,a){a.d(n,{Bg:function(){return v},D2:function(){return b},Jo:function(){return p},Vg:function(){return y},ag:function(){return m},qW:function(){return k},xr:function(){return f}});var o=a(133),s=a(8982),r=a(7051);const i=3e4,c=3e5;let t=null,l=0,u=0,d=null,g=!1;async function m(){try{const e=await(0,s.By)();if(!e||0===Object.keys(e).length)return console.log("No hay información del negocio para sincronizar"),{success:!1,message:"No hay información del negocio para sincronizar"};console.log("Sincronizando información del negocio con el backend:",e);const n=localStorage.getItem("token");n&&o["default"].setToken(n);const a=await o["default"].get("/auth/me");if(!a||!a.success||!a.user||!a.user.restaurante_id)return console.warn("No se pudo obtener el restaurante del usuario actual"),{success:!1,message:"No se pudo obtener el restaurante del usuario actual"};const i=a.user.restaurante_id,c={nombre:e.name,descripcion:e.description,direccion:e.address,telefono:e.contact,logo:e.logo,informacion_pago:JSON.stringify(e.paymentInfo||{})},t=await o["default"].put(`/restaurantes/${i}`,c);return t&&t.success?(console.log("Información del negocio sincronizada con éxito"),l=Date.now(),r.A.emit("business-info-updated",e),{success:!0,message:"Información del negocio sincronizada con éxito",timestamp:l}):(console.warn("Error al sincronizar información del negocio:",t),{success:!1,message:t.message||"Error al sincronizar información del negocio"})}catch(e){return console.error("Error al sincronizar información del negocio:",e),{success:!1,message:e.message||"Error al sincronizar información del negocio"}}}async function f(e=!1){try{const a=Date.now();if(d&&!e&&a-u<c)return console.log("Usando información de negocio en caché"),d;const i=localStorage.getItem("token");i&&o["default"].setToken(i);const t=await o["default"].get("/auth/me");if(!t||!t.success||!t.user||!t.user.restaurante_id)throw console.warn("No se pudo obtener el restaurante del usuario actual"),new Error("No se pudo obtener el restaurante del usuario actual");const l=t.user.restaurante_id,g=await o["default"].get(`/restaurantes/${l}`);if(g&&g.success&&g.restaurante){const e=g.restaurante;let o={};try{e.informacion_pago&&(o=JSON.parse(e.informacion_pago))}catch(n){console.warn("Error al parsear información de pago:",n)}const i={name:e.nombre,description:e.descripcion,address:e.direccion,contact:e.telefono,logo:e.logo,paymentInfo:o};return await(0,s.AU)(i),d=i,u=a,r.A.emit("business-info-updated",i),console.log("Información del negocio obtenida con éxito:",i),i}throw console.warn("Error al obtener información del negocio:",g),new Error(g?.message||"Error al obtener información del negocio")}catch(a){console.error("Error al obtener información del negocio desde el backend:",a);try{const e=await(0,s.By)();if(e)return e}catch(i){console.error("Error al obtener información local:",i)}throw a}}async function v(){try{const e=await(0,s.By)(),n=await f(!0),a=JSON.stringify(e),o=JSON.stringify(n),i=a!==o;return i&&(console.log("Se detectaron cambios en la información del negocio"),await(0,s.AU)(n),r.A.emit("business-info-updated",n)),i}catch(e){return console.error("Error al verificar cambios en información del negocio:",e),!1}}function b(e=!1){e?console.log("Sincronización de información del negocio desactivada (modo vista compartida)"):(t&&clearInterval(t),g||(f().catch((e=>console.error("Error en sincronización inicial:",e))),g=!0),t=setInterval((()=>{v().catch((e=>console.error("Error en verificación periódica:",e)))}),i),console.log("Verificación periódica de información del negocio iniciada"))}function y(){t&&(clearInterval(t),t=null,console.log("Verificación periódica de información del negocio detenida"))}async function p(){try{const e=localStorage.getItem("token");e&&o["default"].setToken(e);const n=await o["default"].get("/restaurantes/migrate/add-informacion-pago");return n&&n.success?(console.log("Migración ejecutada con éxito:",n.message),{success:!0,message:n.message||"Migración ejecutada con éxito"}):(console.warn("Error al ejecutar migración:",n),{success:!1,message:n.message||"Error al ejecutar migración"})}catch(e){return console.error("Error al ejecutar migración:",e),{success:!1,message:e.message||"Error al ejecutar migración"}}}function k(){d=null,u=0}},4070:function(e,n,a){a.r(n),a.d(n,{default:function(){return Y}});var o=a(6768),s=a(4232),r=a(5130);const i={class:"sync-business-info"},c={class:"status-info"},t={class:"status-item"},l={class:"status-item"},u={class:"settings-section"},d={class:"form-group"},g={class:"toggle-switch"},m={class:"form-group"},f=["disabled"],v={class:"actions"},b=["disabled"],y={key:0,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},p=["disabled"],k={key:0,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},E=["disabled"],I={key:0,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},L=["disabled"],h={key:0,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},w={key:1,class:"current-info"},S={class:"info-card"},z={class:"info-header"},C={class:"info-badge"},A={class:"info-content"},_={class:"info-row"},N={class:"info-row"},D={class:"info-row"},R={key:0,class:"info-row logo-preview"},X=["src"],B={key:1,class:"info-row"},Q={class:"payment-info"},j={key:0},$={key:1},W={key:2},x={class:"sync-log"},K={class:"log-container"},V={class:"log-timestamp"},F={class:"log-message"},T={key:0,class:"log-empty"};function q(e,n,a,q,M,U){return(0,o.uX)(),(0,o.CE)("div",i,[n[26]||(n[26]=(0,o.Lk)("h2",null,"Sincronización de Información del Negocio",-1)),q.message?((0,o.uX)(),(0,o.CE)("div",{key:0,class:(0,s.C4)(["alert",{"alert-success":q.success,"alert-danger":!q.success&&q.message}])},(0,s.v_)(q.message),3)):(0,o.Q3)("",!0),(0,o.Lk)("div",c,[(0,o.Lk)("div",t,[n[8]||(n[8]=(0,o.Lk)("strong",null,"Estado de sincronización:",-1)),(0,o.Lk)("span",{class:(0,s.C4)(q.isAutoSyncEnabled?"status-active":"status-inactive")},(0,s.v_)(q.isAutoSyncEnabled?"Activa":"Inactiva"),3)]),(0,o.Lk)("div",l,[n[9]||(n[9]=(0,o.Lk)("strong",null,"Última sincronización:",-1)),(0,o.Lk)("span",null,(0,s.v_)(q.lastSyncFormatted),1)])]),(0,o.Lk)("div",u,[n[14]||(n[14]=(0,o.Lk)("h3",null,"Configuración de Sincronización",-1)),(0,o.Lk)("div",d,[(0,o.Lk)("label",g,[(0,o.bo)((0,o.Lk)("input",{type:"checkbox","onUpdate:modelValue":n[0]||(n[0]=e=>q.isAutoSyncEnabled=e),onChange:n[1]||(n[1]=(...e)=>q.toggleAutoSync&&q.toggleAutoSync(...e))},null,544),[[r.lH,q.isAutoSyncEnabled]]),n[10]||(n[10]=(0,o.Lk)("span",{class:"slider"},null,-1)),n[11]||(n[11]=(0,o.Lk)("span",{class:"toggle-label"},"Sincronización automática",-1))])]),(0,o.Lk)("div",m,[n[13]||(n[13]=(0,o.Lk)("label",null,"Intervalo de verificación:",-1)),(0,o.bo)((0,o.Lk)("select",{"onUpdate:modelValue":n[2]||(n[2]=e=>q.syncInterval=e),onChange:n[3]||(n[3]=(...e)=>q.updateSyncInterval&&q.updateSyncInterval(...e)),disabled:!q.isAutoSyncEnabled},n[12]||(n[12]=[(0,o.Lk)("option",{value:"15000"},"15 segundos (pruebas)",-1),(0,o.Lk)("option",{value:"30000"},"30 segundos",-1),(0,o.Lk)("option",{value:"60000"},"1 minuto",-1),(0,o.Lk)("option",{value:"300000"},"5 minutos",-1)]),40,f),[[r.u1,q.syncInterval]])])]),(0,o.Lk)("div",v,[(0,o.Lk)("button",{onClick:n[4]||(n[4]=(...e)=>q.runMigration&&q.runMigration(...e)),class:"btn btn-primary",disabled:q.loading},[q.loading?((0,o.uX)(),(0,o.CE)("span",y)):(0,o.Q3)("",!0),n[15]||(n[15]=(0,o.eW)(" Ejecutar Migración "))],8,b),(0,o.Lk)("button",{onClick:n[5]||(n[5]=(...e)=>q.syncBusinessInfo&&q.syncBusinessInfo(...e)),class:"btn btn-success",disabled:q.loading},[q.loading?((0,o.uX)(),(0,o.CE)("span",k)):(0,o.Q3)("",!0),n[16]||(n[16]=(0,o.eW)(" Sincronizar Ahora "))],8,p),(0,o.Lk)("button",{onClick:n[6]||(n[6]=(...e)=>q.fetchFromBackend&&q.fetchFromBackend(...e)),class:"btn btn-info",disabled:q.loading},[q.loading?((0,o.uX)(),(0,o.CE)("span",I)):(0,o.Q3)("",!0),n[17]||(n[17]=(0,o.eW)(" Actualizar desde Servidor "))],8,E),(0,o.Lk)("button",{onClick:n[7]||(n[7]=(...e)=>q.syncAndRefresh&&q.syncAndRefresh(...e)),class:"btn btn-warning",disabled:q.loading},[q.loading?((0,o.uX)(),(0,o.CE)("span",h)):(0,o.Q3)("",!0),n[18]||(n[18]=(0,o.eW)(" Sincronizar y Refrescar "))],8,L)]),q.businessInfo?((0,o.uX)(),(0,o.CE)("div",w,[n[24]||(n[24]=(0,o.Lk)("h3",null,"Información Actual del Negocio",-1)),(0,o.Lk)("div",S,[(0,o.Lk)("div",z,[(0,o.Lk)("h4",null,(0,s.v_)(q.businessInfo.name||"Sin nombre"),1),(0,o.Lk)("div",C,(0,s.v_)(q.lastUpdateFormatted),1)]),(0,o.Lk)("div",A,[(0,o.Lk)("div",_,[n[19]||(n[19]=(0,o.Lk)("strong",null,"Descripción:",-1)),(0,o.eW)(" "+(0,s.v_)(q.businessInfo.description||"Sin descripción"),1)]),(0,o.Lk)("div",N,[n[20]||(n[20]=(0,o.Lk)("strong",null,"Dirección:",-1)),(0,o.eW)(" "+(0,s.v_)(q.businessInfo.address||"Sin dirección"),1)]),(0,o.Lk)("div",D,[n[21]||(n[21]=(0,o.Lk)("strong",null,"Contacto:",-1)),(0,o.eW)(" "+(0,s.v_)(q.businessInfo.contact||"Sin contacto"),1)]),q.businessInfo.logo?((0,o.uX)(),(0,o.CE)("div",R,[n[22]||(n[22]=(0,o.Lk)("strong",null,"Logo:",-1)),(0,o.Lk)("img",{src:q.businessInfo.logo,alt:"Logo",class:"logo-thumbnail"},null,8,X)])):(0,o.Q3)("",!0),q.businessInfo.paymentInfo?((0,o.uX)(),(0,o.CE)("div",B,[n[23]||(n[23]=(0,o.Lk)("strong",null,"Información de Pago:",-1)),(0,o.Lk)("div",Q,[q.businessInfo.paymentInfo.qrTitle?((0,o.uX)(),(0,o.CE)("div",j,"QR: "+(0,s.v_)(q.businessInfo.paymentInfo.qrTitle),1)):(0,o.Q3)("",!0),q.businessInfo.paymentInfo.nequiNumber?((0,o.uX)(),(0,o.CE)("div",$,"Nequi: "+(0,s.v_)(q.businessInfo.paymentInfo.nequiNumber),1)):(0,o.Q3)("",!0),q.businessInfo.paymentInfo.bankInfo?((0,o.uX)(),(0,o.CE)("div",W,"Banco: "+(0,s.v_)(q.businessInfo.paymentInfo.bankInfo),1)):(0,o.Q3)("",!0)])])):(0,o.Q3)("",!0)])])])):(0,o.Q3)("",!0),(0,o.Lk)("div",x,[n[25]||(n[25]=(0,o.Lk)("h3",null,"Registro de Sincronización",-1)),(0,o.Lk)("div",K,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(q.syncLogs,((e,n)=>((0,o.uX)(),(0,o.CE)("div",{key:n,class:(0,s.C4)(["log-entry",{"log-success":e.success,"log-error":!e.success}])},[(0,o.Lk)("div",V,(0,s.v_)(q.formatTimestamp(e.timestamp)),1),(0,o.Lk)("div",F,(0,s.v_)(e.message),1)],2)))),128)),0===q.syncLogs.length?((0,o.uX)(),(0,o.CE)("div",T," No hay registros de sincronización. ")):(0,o.Q3)("",!0)])])])}var M=a(144),U=a(2949),J=a(8982),O=a(7051),H={name:"SyncBusinessInfo",setup(){const e=(0,M.KR)(!1),n=(0,M.KR)(!1),a=(0,M.KR)(""),s=(0,M.KR)(null),r=(0,M.KR)(null),i=(0,M.KR)(null),c=(0,M.KR)(!0),t=(0,M.KR)("30000"),l=(0,M.KR)([]),u=(0,o.EW)((()=>r.value?g(r.value):"Nunca")),d=(0,o.EW)((()=>i.value?`Actualizado: ${g(i.value)}`:"")),g=e=>{if(!e)return"";const n=new Date(e);return`${n.toLocaleDateString()} ${n.toLocaleTimeString()}`},m=(e,n=!0)=>{l.value.unshift({message:e,success:n,timestamp:Date.now()}),l.value.length>10&&(l.value=l.value.slice(0,10))},f=e=>{s.value=e,i.value=Date.now(),m("Información del negocio actualizada")};(0,o.sV)((async()=>{try{O.A.on("business-info-updated",f),await v(),c.value&&((0,U.D2)(),m("Sincronización automática iniciada"))}catch(e){console.error("Error al montar el componente:",e),a.value="Error al cargar información del negocio",n.value=!1,m("Error al cargar información del negocio",!1)}})),(0,o.hi)((()=>{O.A.off("business-info-updated",f),(0,U.Vg)()}));const v=async()=>{try{e.value=!0,s.value=await(0,J.By)(),i.value=Date.now()}catch(o){console.error("Error al cargar información del negocio:",o),a.value="Error al cargar información del negocio",n.value=!1,m("Error al cargar información del negocio",!1)}finally{e.value=!1}},b=async()=>{try{e.value=!0,a.value="Ejecutando migración...";const o=await(0,U.Jo)();n.value=o.success,a.value=o.message,o.success?m("Migración ejecutada con éxito"):m(`Error en migración: ${o.message}`,!1)}catch(o){console.error("Error al ejecutar migración:",o),n.value=!1,a.value=o.message||"Error al ejecutar migración",m(`Error en migración: ${o.message}`,!1)}finally{e.value=!1}},y=async()=>{try{e.value=!0,a.value="Sincronizando información...";const o=await(0,U.ag)();n.value=o.success,a.value=o.message,o.success?(r.value=o.timestamp||Date.now(),await v(),m("Sincronización completada con éxito")):m(`Error en sincronización: ${o.message}`,!1)}catch(o){console.error("Error al sincronizar información:",o),n.value=!1,a.value=o.message||"Error al sincronizar información",m(`Error en sincronización: ${o.message}`,!1)}finally{e.value=!1}},p=async()=>{try{e.value=!0,a.value="Obteniendo información desde el servidor...",(0,U.qW)(),s.value=await(0,U.xr)(!0),n.value=!0,a.value="Información actualizada desde el servidor",i.value=Date.now(),m("Información actualizada desde el servidor")}catch(o){console.error("Error al obtener información desde el servidor:",o),n.value=!1,a.value=o.message||"Error al obtener información desde el servidor",m(`Error al obtener información: ${o.message}`,!1)}finally{e.value=!1}},k=async()=>{try{e.value=!0,a.value="Sincronizando y verificando cambios...",await(0,U.ag)();const o=await(0,U.Bg)();o?(n.value=!0,a.value="Se detectaron y aplicaron cambios en la información",m("Se detectaron y aplicaron cambios")):(n.value=!0,a.value="No se detectaron cambios en la información",m("No se detectaron cambios")),await v(),r.value=Date.now()}catch(o){console.error("Error al sincronizar y verificar cambios:",o),n.value=!1,a.value=o.message||"Error al sincronizar y verificar cambios",m(`Error al sincronizar: ${o.message}`,!1)}finally{e.value=!1}},E=()=>{c.value?((0,U.D2)(),m("Sincronización automática activada")):((0,U.Vg)(),m("Sincronización automática desactivada"))},I=()=>{(0,U.Vg)(),m(`Intervalo de sincronización actualizado a ${parseInt(t.value)/1e3} segundos`),c.value&&(0,U.D2)()};return{loading:e,success:n,message:a,businessInfo:s,lastSync:r,lastSyncFormatted:u,lastUpdateFormatted:d,isAutoSyncEnabled:c,syncInterval:t,syncLogs:l,runMigration:b,syncBusinessInfo:y,fetchFromBackend:p,syncAndRefresh:k,toggleAutoSync:E,updateSyncInterval:I,formatTimestamp:g}}},P=a(1241);const G=(0,P.A)(H,[["render",q],["__scopeId","data-v-36ce8d12"]]);var Y=G}}]);
//# sourceMappingURL=70.1c38969d.js.map