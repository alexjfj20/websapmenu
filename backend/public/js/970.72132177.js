"use strict";(self["webpackChunkwebsap"]=self["webpackChunkwebsap"]||[]).push([[970],{4970:function(e,a,l){l.d(a,{A:function(){return j}});l(8111),l(2489),l(3579);var s=l(6768),r=l(4232),n=l(144),t=l(6429),o=l(7051),i=l(133);const c={class:"admin-reservas"},u={class:"reservas-header"},d={class:"action-buttons"},v=["disabled"],k={key:0},m={key:1},f=["disabled"],L={class:"reservas-container"},h={key:0,class:"loading-spinner"},p={key:1,class:"no-reservations"},b={key:2,class:"reservations-list"},g={class:"table-responsive"},C={class:"reservation-table"},y=["href"],E={class:"actions-cell"},w=["onClick"],A=["onClick","disabled"],_=["onClick","disabled"],R={key:0,class:"reservation-modal"},X={class:"modal-content"},N={class:"reservation-details"},$={key:0},z={key:1},T={key:2},W={key:3},P={class:"modal-actions"},K=["disabled"],Q=["disabled"],I={key:1,class:"delete-modal-overlay"},M={class:"delete-modal"},S={class:"delete-modal-header"},F={class:"delete-modal-footer"},x=["disabled"],D={key:0},B={key:1},G=5;var O={__name:"AdminReservas",props:{readOnly:{type:Boolean,default:!1}},setup(e,{expose:a}){const l=(0,n.KR)([]),O=(0,n.KR)(!0),H=(0,n.KR)(null),V=(0,n.KR)(!1),j=(0,n.KR)(0),Y=(0,n.KR)("idle"),q=(0,n.KR)(null),J=(0,n.Kh)({visible:!1,message:"",type:"info"}),U=(e,a="info")=>{J.message=e,J.type=a,J.visible=!0,setTimeout((()=>{J.visible=!1}),5e3)},Z=async()=>{console.log("üîÑ Actualizando lista de reservas...");try{O.value;O.value=!0;const e=await(0,t.SG)();if(!e.success)throw new Error(e.error||"Error al actualizar las reservas");l.value=e.reservations,console.log("‚úÖ Lista de reservas actualizada correctamente:",l.value.length)}catch(e){console.error("‚ùå Error al actualizar reservas:",e),U("Error al actualizar las reservas","error")}finally{O.value=!1}},ee=()=>{try{const e=new Audio("/notification.mp3");e.play().catch((e=>console.log("No se pudo reproducir sonido:",e)))}catch(e){console.error("Error al reproducir sonido:",e)}},ae=async()=>{O.value=!0;try{console.log("üîÑ Cargando reservas...");const e=await(0,t.SG)();if(!e.success)throw new Error(e.error||"Error al cargar las reservas");l.value=e.reservations,console.log("‚úÖ Reservas cargadas correctamente:",l.value.length),le()}catch(e){console.error("‚ùå Error al cargar reservas:",e),U("Error al cargar las reservas","error")}finally{O.value=!1}},le=async(e=!1)=>{if(!("error"===Y.value&&j.value>=G)||e){Y.value="connecting";try{const e=await i["default"].get("/whatsapp/notificaciones").catch((e=>{j.value++;const a=Math.min(1e3*Math.pow(2,j.value),3e4);return console.log(`No se pudieron verificar notificaciones (intento ${j.value}/${G}), reintentando en ${a/1e3}s`),j.value<G?(q.value&&clearTimeout(q.value),q.value=setTimeout((()=>{le(!0)}),a)):(Y.value="error",console.log("M√°ximo de reintentos alcanzado, desistiendo de verificar notificaciones")),null}));e&&e.success&&(j.value=0,Y.value="connected",e.hayNotificaciones&&(U(`${e.cantidad} nueva(s) reserva(s) de WhatsApp`,"success"),ee(),Z()))}catch(a){0}}},se=e=>{console.log("üîî Nueva reserva recibida:",e);const a=l.value.findIndex((a=>a.id===e.id));a>=0?(l.value[a]={...e},console.log("üîÑ Reserva actualizada:",e.id)):(l.value.unshift(e),console.log("‚ûï Nueva reserva a√±adida:",e.id),U(`Nueva reserva recibida de ${e.fullName}`,"success"),ee())},re=e=>{console.log("üîÑ Actualizaci√≥n de reserva recibida:",e);const a=l.value.findIndex((a=>a.id===e.id));-1!==a&&(l.value[a].status=e.status,console.log("‚úÖ Estado de reserva actualizado a:",e.status))};let ne=null;(0,s.sV)((()=>{ae(),o.A.on("nueva-reserva",se),o.A.on("reserva-actualizada",re),o.A.on("refresh-reservations",Z),ne=setInterval(le,3e4),console.log("‚úÖ AdminReservas montado y escuchando eventos")})),(0,s.hi)((()=>{o.A.off("nueva-reserva",se),o.A.off("reserva-actualizada",re),o.A.off("refresh-reservations",Z),ne&&clearInterval(ne),q.value&&clearTimeout(q.value),console.log("üõë AdminReservas desmontado")})),a({refreshReservations:Z});const te=e=>{if(!e)return"";try{if(e.includes("T")&&e.includes("/")){const a=e.split("/");if(3===a.length){const e=a[0].split("T")[0];return`${e}/${a[1]}/${a[2]}`}}if(e.includes("-")){const a=e.split("-");if(3===a.length)return`${a[2]}/${a[1]}/${a[0]}`}if(e.includes("/")&&!e.includes("T"))return e;const a=new Date(e);if(!isNaN(a.getTime())){const e=a.getDate().toString().padStart(2,"0"),l=(a.getMonth()+1).toString().padStart(2,"0"),s=a.getFullYear();return`${e}/${l}/${s}`}return e}catch(a){return console.error("Error al formatear fecha:",a),e}},oe=e=>{switch(e){case"confirmed":return"Confirmada";case"pending":return"Pendiente";case"cancelled":return"Cancelada";default:return e}},ie=e=>{H.value=e},ce=async e=>{try{const a=await(0,t.sB)(e.id,"confirmed");if(!a.success)throw new Error(a.error||"Error al confirmar la reserva");e.status="confirmed",U("Reserva confirmada correctamente","success")}catch(a){console.error("Error al confirmar reserva:",a),U("Error al confirmar la reserva","error")}},ue=async e=>{try{const a=await(0,t.sB)(e.id,"cancelled");if(!a.success)throw new Error(a.error||"Error al cancelar la reserva");e.status="cancelled",U("Reserva cancelada correctamente","success")}catch(a){console.error("Error al cancelar reserva:",a),U("Error al cancelar la reserva","error")}},de=e=>{e.mobilePhone?window.location.href=`tel:${e.mobilePhone}`:U("No hay n√∫mero de tel√©fono disponible","warning")},ve=async()=>{O.value=!0;try{const a=l.value.filter((e=>(0,t.CN)(e,30)));if(0===a.length)return U("No hay reservas antiguas para eliminar","info"),void(O.value=!1);let s=0,r=0;for(const l of a)try{const e=await(0,t.MT)(l.id);e.success?s++:(r++,console.error("Error al eliminar reserva:",l.id,e.error))}catch(e){r++,console.error("Error al eliminar reserva:",l.id,e)}await Z(),s>0&&U(`${s} reservas antiguas eliminadas correctamente`,"success"),r>0&&U(`No se pudieron eliminar ${r} reservas`,"warning")}catch(e){console.error("Error al eliminar reservas antiguas:",e),U("Error al eliminar las reservas antiguas","error")}finally{O.value=!1,V.value=!1}},ke=(0,s.EW)((()=>l.value.some((e=>(0,t.CN)(e,30)))));return(a,n)=>((0,s.uX)(),(0,s.CE)("div",c,[(0,s.Lk)("div",u,[n[8]||(n[8]=(0,s.Lk)("h2",{class:"admin-section-title"},"Gesti√≥n de Reservas",-1)),(0,s.Lk)("div",d,[(0,s.Lk)("button",{class:"refresh-btn",onClick:Z,disabled:O.value,title:"Actualizar reservas"},[O.value?((0,s.uX)(),(0,s.CE)("span",k,"Actualizando...")):((0,s.uX)(),(0,s.CE)("span",m,"üîÑ Actualizar"))],8,v),(0,s.Lk)("button",{class:"delete-old-btn",onClick:n[0]||(n[0]=e=>V.value=!0),disabled:O.value||!ke.value,title:"Eliminar reservas antiguas (m√°s de 30 d√≠as)"},n[7]||(n[7]=[(0,s.Lk)("span",null,"üóëÔ∏è Eliminar Antiguas",-1)]),8,f)])]),(0,s.Lk)("div",L,[O.value?((0,s.uX)(),(0,s.CE)("div",h,n[9]||(n[9]=[(0,s.Lk)("div",{class:"spinner"},null,-1),(0,s.Lk)("p",null,"Cargando reservas...",-1)]))):0===l.value.length?((0,s.uX)(),(0,s.CE)("div",p,n[10]||(n[10]=[(0,s.Lk)("p",null,"A√∫n no hay reservas registradas",-1)]))):((0,s.uX)(),(0,s.CE)("div",b,[(0,s.Lk)("div",g,[(0,s.Lk)("table",C,[n[11]||(n[11]=(0,s.Lk)("thead",null,[(0,s.Lk)("tr",null,[(0,s.Lk)("th",null,"Fecha"),(0,s.Lk)("th",null,"Hora"),(0,s.Lk)("th",null,"Cliente"),(0,s.Lk)("th",null,"Tel√©fono"),(0,s.Lk)("th",null,"Personas"),(0,s.Lk)("th",null,"Estado"),(0,s.Lk)("th",null,"Acciones")])],-1)),(0,s.Lk)("tbody",null,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(l.value,((a,l)=>((0,s.uX)(),(0,s.CE)("tr",{key:l,class:(0,r.C4)({confirmed:"confirmed"===a.status,pending:"pending"===a.status,cancelled:"cancelled"===a.status})},[(0,s.Lk)("td",null,(0,r.v_)(te(a.date)),1),(0,s.Lk)("td",null,(0,r.v_)(a.time),1),(0,s.Lk)("td",null,(0,r.v_)(a.fullName),1),(0,s.Lk)("td",null,[(0,s.Lk)("a",{href:`tel:${a.mobilePhone}`},(0,r.v_)(a.mobilePhone),9,y)]),(0,s.Lk)("td",null,(0,r.v_)(a.peopleCount),1),(0,s.Lk)("td",null,[(0,s.Lk)("span",{class:(0,r.C4)(["status-badge",a.status])},(0,r.v_)(oe(a.status)),3)]),(0,s.Lk)("td",E,[(0,s.Lk)("button",{onClick:e=>ie(a),class:"action-btn view-btn",title:"Ver detalles"}," üëÅÔ∏è ",8,w),e.readOnly?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.CE)("button",{key:0,onClick:e=>ce(a),class:"action-btn confirm-btn",title:"Confirmar reserva",disabled:"confirmed"===a.status}," ‚úÖ ",8,A)),e.readOnly?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.CE)("button",{key:1,onClick:e=>ue(a),class:"action-btn cancel-btn",title:"Cancelar reserva",disabled:"cancelled"===a.status}," ‚ùå ",8,_))])],2)))),128))])])])]))]),H.value?((0,s.uX)(),(0,s.CE)("div",R,[(0,s.Lk)("div",X,[(0,s.Lk)("span",{class:"close-modal",onClick:n[1]||(n[1]=e=>H.value=null)},"√ó"),n[23]||(n[23]=(0,s.Lk)("h3",null,"Detalles de la Reserva",-1)),(0,s.Lk)("div",N,[(0,s.Lk)("p",null,[n[12]||(n[12]=(0,s.Lk)("strong",null,"Cliente:",-1)),(0,s.eW)(" "+(0,r.v_)(H.value.fullName),1)]),(0,s.Lk)("p",null,[n[13]||(n[13]=(0,s.Lk)("strong",null,"Tel√©fono M√≥vil:",-1)),(0,s.eW)(" "+(0,r.v_)(H.value.mobilePhone),1)]),H.value.landlinePhone?((0,s.uX)(),(0,s.CE)("p",$,[n[14]||(n[14]=(0,s.Lk)("strong",null,"Tel√©fono Fijo:",-1)),(0,s.eW)(" "+(0,r.v_)(H.value.landlinePhone),1)])):(0,s.Q3)("",!0),H.value.email?((0,s.uX)(),(0,s.CE)("p",z,[n[15]||(n[15]=(0,s.Lk)("strong",null,"Email:",-1)),(0,s.eW)(" "+(0,r.v_)(H.value.email),1)])):(0,s.Q3)("",!0),H.value.address?((0,s.uX)(),(0,s.CE)("p",T,[n[16]||(n[16]=(0,s.Lk)("strong",null,"Direcci√≥n:",-1)),(0,s.eW)(" "+(0,r.v_)(H.value.address),1)])):(0,s.Q3)("",!0),(0,s.Lk)("p",null,[n[17]||(n[17]=(0,s.Lk)("strong",null,"Fecha:",-1)),(0,s.eW)(" "+(0,r.v_)(te(H.value.date)),1)]),(0,s.Lk)("p",null,[n[18]||(n[18]=(0,s.Lk)("strong",null,"Hora:",-1)),(0,s.eW)(" "+(0,r.v_)(H.value.time),1)]),(0,s.Lk)("p",null,[n[19]||(n[19]=(0,s.Lk)("strong",null,"N√∫mero de Personas:",-1)),(0,s.eW)(" "+(0,r.v_)(H.value.peopleCount),1)]),H.value.notes?((0,s.uX)(),(0,s.CE)("p",W,[n[20]||(n[20]=(0,s.Lk)("strong",null,"Notas Adicionales:",-1)),(0,s.eW)(" "+(0,r.v_)(H.value.notes),1)])):(0,s.Q3)("",!0),(0,s.Lk)("p",null,[n[21]||(n[21]=(0,s.Lk)("strong",null,"Estado:",-1)),n[22]||(n[22]=(0,s.eW)()),(0,s.Lk)("span",{class:(0,r.C4)(["status-badge",H.value.status])},(0,r.v_)(oe(H.value.status)),3)])]),(0,s.Lk)("div",P,[(0,s.Lk)("button",{onClick:n[2]||(n[2]=e=>ce(H.value)),class:"action-btn confirm-btn",disabled:"confirmed"===H.value.status}," Confirmar Reserva ",8,K),(0,s.Lk)("button",{onClick:n[3]||(n[3]=e=>ue(H.value)),class:"action-btn cancel-btn",disabled:"cancelled"===H.value.status}," Cancelar Reserva ",8,Q),(0,s.Lk)("button",{onClick:n[4]||(n[4]=e=>de(H.value)),class:"action-btn contact-btn"}," Contactar Cliente ")])])])):(0,s.Q3)("",!0),V.value?((0,s.uX)(),(0,s.CE)("div",I,[(0,s.Lk)("div",M,[(0,s.Lk)("div",S,[n[24]||(n[24]=(0,s.Lk)("h3",null,"Confirmar eliminaci√≥n",-1)),(0,s.Lk)("button",{class:"close-modal",onClick:n[5]||(n[5]=e=>V.value=!1)},"√ó")]),n[25]||(n[25]=(0,s.Lk)("div",{class:"delete-modal-body"},[(0,s.Lk)("div",{class:"delete-icon"},[(0,s.Lk)("span",null,"üóëÔ∏è")]),(0,s.Lk)("p",null,"¬øEst√°s seguro de eliminar las reservas antiguas?"),(0,s.Lk)("p",{class:"delete-modal-info"},"Esta acci√≥n eliminar√° todas las reservas con m√°s de 30 d√≠as de antig√ºedad y no se puede deshacer.")],-1)),(0,s.Lk)("div",F,[(0,s.Lk)("button",{class:"cancel-btn",onClick:n[6]||(n[6]=e=>V.value=!1)},"Cancelar"),(0,s.Lk)("button",{class:"confirm-btn",onClick:ve,disabled:O.value},[O.value?((0,s.uX)(),(0,s.CE)("span",D,"Eliminando...")):((0,s.uX)(),(0,s.CE)("span",B,"Eliminar"))],8,x)])])])):(0,s.Q3)("",!0),J.visible?((0,s.uX)(),(0,s.CE)("div",{key:2,class:(0,r.C4)(["toast-notification",J.type])},(0,r.v_)(J.message),3)):(0,s.Q3)("",!0)]))}},H=l(1241);const V=(0,H.A)(O,[["__scopeId","data-v-5a5d5360"]]);var j=V}}]);
//# sourceMappingURL=970.72132177.js.map