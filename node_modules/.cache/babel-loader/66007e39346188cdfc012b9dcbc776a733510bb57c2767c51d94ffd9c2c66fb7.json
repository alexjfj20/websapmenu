{"ast":null,"code":"import { onMounted, onUnmounted, ref } from 'vue';\nimport { saveWhatsAppReservation } from '../services/reservaService';\nimport eventBus from '../utils/eventBus';\nexport default {\n  __name: 'WhatsAppReservationHandler',\n  setup(__props, {\n    expose: __expose\n  }) {\n    const isListening = ref(false);\n    const lastProcessedMessageId = ref(null);\n\n    // Funci√≥n para procesar mensajes de WhatsApp\n    const processWhatsAppMessage = async event => {\n      // Solo procesamos mensajes que vengan de la ventana principal o del mismo origen\n      if (event.source !== window && event.source !== window.parent) return;\n      try {\n        // Verificar que el mensaje sea de tipo reserva de WhatsApp\n        if (event.data && event.data.type === 'whatsapp_reservation') {\n          console.log('üì± Recibido mensaje de reserva desde WhatsApp (window):', event.data);\n\n          // Evitar procesar el mismo mensaje dos veces\n          if (lastProcessedMessageId.value === JSON.stringify(event.data)) {\n            console.log('‚ö†Ô∏è Mensaje ya procesado, ignorando duplicado');\n            return;\n          }\n          lastProcessedMessageId.value = JSON.stringify(event.data);\n\n          // Guardar la reserva usando el servicio\n          const result = await saveWhatsAppReservation(event.data.reservation);\n          if (result.success) {\n            console.log('‚úÖ Reserva de WhatsApp guardada correctamente:', result.reservation);\n\n            // Notificar a la ventana que envi√≥ el mensaje\n            if (event.source && event.source.postMessage) {\n              event.source.postMessage({\n                type: 'whatsapp_reservation_response',\n                success: true,\n                message: 'Reserva recibida correctamente'\n              }, '*');\n            }\n          } else {\n            throw new Error(result.error);\n          }\n        }\n      } catch (error) {\n        console.error('‚ùå Error al procesar mensaje de WhatsApp:', error);\n\n        // Notificar error a la ventana que envi√≥ el mensaje\n        if (event.source && event.source.postMessage) {\n          event.source.postMessage({\n            type: 'whatsapp_reservation_response',\n            success: false,\n            message: 'Error al procesar la reserva: ' + error.message\n          }, '*');\n        }\n      }\n    };\n\n    // Funci√≥n para procesar mensajes del eventBus\n    const processEventBusMessage = async message => {\n      try {\n        console.log('üì± Recibido mensaje de reserva desde eventBus:', message);\n\n        // Verificar que el mensaje sea de tipo reserva de WhatsApp\n        if (message && message.type === 'whatsapp_reservation') {\n          // Usar el ID del mensaje para evitar duplicados\n          const messageId = message.id || JSON.stringify(message);\n\n          // Evitar procesar el mismo mensaje dos veces\n          if (lastProcessedMessageId.value === messageId) {\n            console.log('‚ö†Ô∏è Mensaje ya procesado, ignorando duplicado');\n            return;\n          }\n          lastProcessedMessageId.value = messageId;\n\n          // Guardar la reserva usando el servicio\n          const result = await saveWhatsAppReservation(message.reservation);\n          if (result.success) {\n            console.log('‚úÖ Reserva de WhatsApp (eventBus) guardada correctamente:', result.reservation);\n\n            // Emitir evento de respuesta\n            eventBus.emit('whatsapp_reservation_response', {\n              success: true,\n              message: 'Reserva recibida correctamente'\n            });\n          } else {\n            throw new Error(result.error);\n          }\n        }\n      } catch (error) {\n        console.error('‚ùå Error al procesar mensaje de WhatsApp desde eventBus:', error);\n\n        // Emitir evento de error\n        eventBus.emit('whatsapp_reservation_response', {\n          success: false,\n          message: 'Error al procesar la reserva: ' + error.message\n        });\n      }\n    };\n\n    // Configurar el listener de mensajes al montar el componente\n    onMounted(() => {\n      if (!isListening.value) {\n        // Escuchar mensajes de window\n        window.addEventListener('message', processWhatsAppMessage);\n\n        // Escuchar mensajes del eventBus\n        eventBus.on('whatsapp_message', processEventBusMessage);\n        isListening.value = true;\n        console.log('üîÑ WhatsAppReservationHandler montado y escuchando mensajes');\n\n        // Exponer la funci√≥n de simulaci√≥n en window para pruebas\n        window.testWhatsAppReservation = simulateWhatsAppReservation;\n      }\n    });\n\n    // Limpiar el listener al desmontar el componente\n    onUnmounted(() => {\n      if (isListening.value) {\n        // Eliminar listener de window\n        window.removeEventListener('message', processWhatsAppMessage);\n\n        // Eliminar listener del eventBus\n        eventBus.off('whatsapp_message', processEventBusMessage);\n        isListening.value = false;\n        console.log('üõë WhatsAppReservationHandler desmontado');\n\n        // Eliminar la funci√≥n de simulaci√≥n\n        if (window.testWhatsAppReservation) {\n          delete window.testWhatsAppReservation;\n        }\n      }\n    });\n\n    // Funci√≥n para simular una reserva de WhatsApp (para pruebas)\n    const simulateWhatsAppReservation = async (customData = {}) => {\n      try {\n        console.log(' Simulando reserva de WhatsApp con datos:', customData);\n\n        // Datos por defecto para la reserva\n        const defaultData = {\n          nombre: 'Cliente de Prueba WhatsApp',\n          telefono: '612345678',\n          email: 'whatsapp@example.com',\n          fecha: new Date().toISOString().split('T')[0],\n          // Hoy\n          hora: '20:00',\n          personas: 3,\n          notas: 'Reserva de prueba desde WhatsApp'\n        };\n\n        // Combinar datos por defecto con datos personalizados\n        const whatsappData = {\n          ...defaultData,\n          ...customData\n        };\n\n        // Crear un evento similar al que enviar√≠a WhatsApp\n        const whatsappEvent = {\n          data: {\n            type: 'whatsapp_reservation',\n            reservation: whatsappData,\n            timestamp: Date.now()\n          },\n          source: window\n        };\n\n        // Procesar el evento simulado\n        await processWhatsAppMessage(whatsappEvent);\n        return true;\n      } catch (error) {\n        console.error(' Error al simular reserva de WhatsApp:', error);\n        return false;\n      }\n    };\n\n    // Exponer la funci√≥n de simulaci√≥n para pruebas\n    __expose({\n      simulateWhatsAppReservation\n    });\n    const __returned__ = {\n      isListening,\n      lastProcessedMessageId,\n      processWhatsAppMessage,\n      processEventBusMessage,\n      simulateWhatsAppReservation,\n      onMounted,\n      onUnmounted,\n      ref,\n      get saveWhatsAppReservation() {\n        return saveWhatsAppReservation;\n      },\n      get eventBus() {\n        return eventBus;\n      }\n    };\n    Object.defineProperty(__returned__, '__isScriptSetup', {\n      enumerable: false,\n      value: true\n    });\n    return __returned__;\n  }\n};","map":{"version":3,"names":["onMounted","onUnmounted","ref","saveWhatsAppReservation","eventBus","isListening","lastProcessedMessageId","processWhatsAppMessage","event","source","window","parent","data","type","console","log","value","JSON","stringify","result","reservation","success","postMessage","message","Error","error","processEventBusMessage","messageId","id","emit","addEventListener","on","testWhatsAppReservation","simulateWhatsAppReservation","removeEventListener","off","customData","defaultData","nombre","telefono","email","fecha","Date","toISOString","split","hora","personas","notas","whatsappData","whatsappEvent","timestamp","now","__expose"],"sources":["F:/Driver google/VUE.JS-2/VUE-JS/websap/src/components/WhatsAppReservationHandler.vue"],"sourcesContent":["<template>\n  <!-- Este componente no tiene representaci√≥n visual, solo maneja la l√≥gica -->\n  <div style=\"display: none;\">\n    <p>Manejador de reservas de WhatsApp activo</p>\n  </div>\n</template>\n\n<script setup>\nimport { onMounted, onUnmounted, ref } from 'vue';\nimport { saveWhatsAppReservation } from '../services/reservaService';\nimport eventBus from '../utils/eventBus';\n\nconst isListening = ref(false);\nconst lastProcessedMessageId = ref(null);\n\n// Funci√≥n para procesar mensajes de WhatsApp\nconst processWhatsAppMessage = async (event) => {\n  // Solo procesamos mensajes que vengan de la ventana principal o del mismo origen\n  if (event.source !== window && event.source !== window.parent) return;\n  \n  try {\n    // Verificar que el mensaje sea de tipo reserva de WhatsApp\n    if (event.data && event.data.type === 'whatsapp_reservation') {\n      console.log('üì± Recibido mensaje de reserva desde WhatsApp (window):', event.data);\n      \n      // Evitar procesar el mismo mensaje dos veces\n      if (lastProcessedMessageId.value === JSON.stringify(event.data)) {\n        console.log('‚ö†Ô∏è Mensaje ya procesado, ignorando duplicado');\n        return;\n      }\n      \n      lastProcessedMessageId.value = JSON.stringify(event.data);\n      \n      // Guardar la reserva usando el servicio\n      const result = await saveWhatsAppReservation(event.data.reservation);\n      \n      if (result.success) {\n        console.log('‚úÖ Reserva de WhatsApp guardada correctamente:', result.reservation);\n        \n        // Notificar a la ventana que envi√≥ el mensaje\n        if (event.source && event.source.postMessage) {\n          event.source.postMessage({\n            type: 'whatsapp_reservation_response',\n            success: true,\n            message: 'Reserva recibida correctamente'\n          }, '*');\n        }\n      } else {\n        throw new Error(result.error);\n      }\n    }\n  } catch (error) {\n    console.error('‚ùå Error al procesar mensaje de WhatsApp:', error);\n    \n    // Notificar error a la ventana que envi√≥ el mensaje\n    if (event.source && event.source.postMessage) {\n      event.source.postMessage({\n        type: 'whatsapp_reservation_response',\n        success: false,\n        message: 'Error al procesar la reserva: ' + error.message\n      }, '*');\n    }\n  }\n};\n\n// Funci√≥n para procesar mensajes del eventBus\nconst processEventBusMessage = async (message) => {\n  try {\n    console.log('üì± Recibido mensaje de reserva desde eventBus:', message);\n    \n    // Verificar que el mensaje sea de tipo reserva de WhatsApp\n    if (message && message.type === 'whatsapp_reservation') {\n      // Usar el ID del mensaje para evitar duplicados\n      const messageId = message.id || JSON.stringify(message);\n      \n      // Evitar procesar el mismo mensaje dos veces\n      if (lastProcessedMessageId.value === messageId) {\n        console.log('‚ö†Ô∏è Mensaje ya procesado, ignorando duplicado');\n        return;\n      }\n      \n      lastProcessedMessageId.value = messageId;\n      \n      // Guardar la reserva usando el servicio\n      const result = await saveWhatsAppReservation(message.reservation);\n      \n      if (result.success) {\n        console.log('‚úÖ Reserva de WhatsApp (eventBus) guardada correctamente:', result.reservation);\n        \n        // Emitir evento de respuesta\n        eventBus.emit('whatsapp_reservation_response', {\n          success: true,\n          message: 'Reserva recibida correctamente'\n        });\n      } else {\n        throw new Error(result.error);\n      }\n    }\n  } catch (error) {\n    console.error('‚ùå Error al procesar mensaje de WhatsApp desde eventBus:', error);\n    \n    // Emitir evento de error\n    eventBus.emit('whatsapp_reservation_response', {\n      success: false,\n      message: 'Error al procesar la reserva: ' + error.message\n    });\n  }\n};\n\n// Configurar el listener de mensajes al montar el componente\nonMounted(() => {\n  if (!isListening.value) {\n    // Escuchar mensajes de window\n    window.addEventListener('message', processWhatsAppMessage);\n    \n    // Escuchar mensajes del eventBus\n    eventBus.on('whatsapp_message', processEventBusMessage);\n    \n    isListening.value = true;\n    console.log('üîÑ WhatsAppReservationHandler montado y escuchando mensajes');\n    \n    // Exponer la funci√≥n de simulaci√≥n en window para pruebas\n    window.testWhatsAppReservation = simulateWhatsAppReservation;\n  }\n});\n\n// Limpiar el listener al desmontar el componente\nonUnmounted(() => {\n  if (isListening.value) {\n    // Eliminar listener de window\n    window.removeEventListener('message', processWhatsAppMessage);\n    \n    // Eliminar listener del eventBus\n    eventBus.off('whatsapp_message', processEventBusMessage);\n    \n    isListening.value = false;\n    console.log('üõë WhatsAppReservationHandler desmontado');\n    \n    // Eliminar la funci√≥n de simulaci√≥n\n    if (window.testWhatsAppReservation) {\n      delete window.testWhatsAppReservation;\n    }\n  }\n});\n\n// Funci√≥n para simular una reserva de WhatsApp (para pruebas)\nconst simulateWhatsAppReservation = async (customData = {}) => {\n  try {\n    console.log(' Simulando reserva de WhatsApp con datos:', customData);\n    \n    // Datos por defecto para la reserva\n    const defaultData = {\n      nombre: 'Cliente de Prueba WhatsApp',\n      telefono: '612345678',\n      email: 'whatsapp@example.com',\n      fecha: new Date().toISOString().split('T')[0], // Hoy\n      hora: '20:00',\n      personas: 3,\n      notas: 'Reserva de prueba desde WhatsApp'\n    };\n    \n    // Combinar datos por defecto con datos personalizados\n    const whatsappData = { ...defaultData, ...customData };\n    \n    // Crear un evento similar al que enviar√≠a WhatsApp\n    const whatsappEvent = {\n      data: {\n        type: 'whatsapp_reservation',\n        reservation: whatsappData,\n        timestamp: Date.now()\n      },\n      source: window\n    };\n    \n    // Procesar el evento simulado\n    await processWhatsAppMessage(whatsappEvent);\n    \n    return true;\n  } catch (error) {\n    console.error(' Error al simular reserva de WhatsApp:', error);\n    return false;\n  }\n};\n\n// Exponer la funci√≥n de simulaci√≥n para pruebas\ndefineExpose({ simulateWhatsAppReservation });\n</script>\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}