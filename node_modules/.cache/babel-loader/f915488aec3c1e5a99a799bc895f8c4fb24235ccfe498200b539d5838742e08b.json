{"ast":null,"code":"import { createCommentVNode as _createCommentVNode, createElementVNode as _createElementVNode, Fragment as _Fragment, openBlock as _openBlock, createElementBlock as _createElementBlock } from \"vue\";\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(_Fragment, null, [_createCommentVNode(\" Este componente no tiene representación visual, solo maneja la lógica \"), _cache[0] || (_cache[0] = _createElementVNode(\"div\", {\n    style: {\n      \"display\": \"none\"\n    }\n  }, [_createElementVNode(\"p\", null, \"Manejador de reservas de WhatsApp activo\")], -1 /* HOISTED */))], 2112 /* STABLE_FRAGMENT, DEV_ROOT_FRAGMENT */);\n}","map":{"version":3,"names":["_createElementBlock","_Fragment","_createCommentVNode","_createElementVNode","style"],"sources":["F:\\Driver google\\VUE.JS-2\\VUE-JS\\websap\\src\\components\\WhatsAppReservationHandler.vue"],"sourcesContent":["<template>\n  <!-- Este componente no tiene representación visual, solo maneja la lógica -->\n  <div style=\"display: none;\">\n    <p>Manejador de reservas de WhatsApp activo</p>\n  </div>\n</template>\n\n<script setup>\nimport { ref, onMounted, onUnmounted } from 'vue';\nimport { saveWhatsAppReservation } from '../services/reservaService';\nimport eventBus from '../utils/eventBus';\n\nconst isProcessing = ref(false);\nconst lastProcessedMessage = ref('');\n\n// Función para procesar mensajes de WhatsApp\nconst processWhatsAppMessage = async (message) => {\n  try {\n    // Evitar procesar el mismo mensaje más de una vez\n    if (message === lastProcessedMessage.value) {\n      console.log('Mensaje ya procesado, ignorando duplicado:', message);\n      return;\n    }\n    \n    console.log('Procesando mensaje de WhatsApp:', message);\n    isProcessing.value = true;\n    lastProcessedMessage.value = message;\n    \n    // Extraer información del mensaje\n    const data = extractReservationData(message);\n    \n    if (!data) {\n      console.warn('No se pudo extraer información de reserva del mensaje:', message);\n      return;\n    }\n    \n    console.log('Datos extraídos del mensaje:', data);\n    \n    // Guardar la reserva\n    const result = await saveWhatsAppReservation(data);\n    \n    if (result.success) {\n      console.log('Reserva de WhatsApp guardada correctamente:', result.reservation);\n      \n      // Emitir evento para actualizar la lista de reservas\n      eventBus.emit('nueva-reserva', result.reservation);\n      eventBus.emit('refresh-reservations');\n      \n      console.log('Eventos emitidos: nueva-reserva y refresh-reservations');\n    } else {\n      console.error('Error al guardar reserva de WhatsApp:', result.error);\n    }\n  } catch (error) {\n    console.error('Error al procesar mensaje de WhatsApp:', error);\n  } finally {\n    isProcessing.value = false;\n  }\n};\n\n// Función para extraer datos de reserva del mensaje\nconst extractReservationData = (message) => {\n  // Implementación básica para extraer datos\n  // En un caso real, se usaría una expresión regular más robusta\n  try {\n    // Buscar patrones comunes en el mensaje\n    const nombreMatch = message.match(/\\*Nombre:\\*\\s*([^\\n]+)/i);\n    const telefonoMatch = message.match(/\\*Teléfono móvil:\\*\\s*([^\\n]+)/i);\n    const fechaMatch = message.match(/\\*Fecha:\\*\\s*([^\\n]+)/i);\n    const horaMatch = message.match(/\\*Hora:\\*\\s*([^\\n]+)/i);\n    const personasMatch = message.match(/\\*Personas:\\*\\s*([^\\n]+)/i);\n    const notasMatch = message.match(/\\*Notas:\\*\\s*([^\\n]+)/i);\n    const emailMatch = message.match(/\\*Email:\\*\\s*([^\\n]+)/i);\n    \n    // Si no encontramos al menos nombre y teléfono, no es una reserva válida\n    if (!nombreMatch && !telefonoMatch) {\n      console.warn('El mensaje no contiene información suficiente para una reserva');\n      return null;\n    }\n    \n    // Construir objeto de datos\n    return {\n      nombre: nombreMatch ? nombreMatch[1].trim() : 'Cliente sin nombre',\n      telefono: telefonoMatch ? telefonoMatch[1].trim() : '',\n      email: emailMatch ? emailMatch[1].trim() : '',\n      fecha: fechaMatch ? fechaMatch[1].trim() : new Date().toISOString().split('T')[0],\n      hora: horaMatch ? horaMatch[1].trim() : '19:00',\n      personas: personasMatch ? parseInt(personasMatch[1].trim(), 10) || 2 : 2,\n      notas: notasMatch ? notasMatch[1].trim() : 'Reserva desde WhatsApp'\n    };\n  } catch (error) {\n    console.error('Error al extraer datos del mensaje:', error);\n    return null;\n  }\n};\n\n// Función para simular la recepción de un mensaje de WhatsApp\nconst simulateWhatsAppMessage = (message) => {\n  console.log('Mensaje de WhatsApp simulado recibido');\n  processWhatsAppMessage(message);\n};\n\n// Escuchar eventos de mensajes de WhatsApp\nonMounted(() => {\n  console.log('WhatsAppReservationHandler montado');\n  eventBus.on('whatsapp-message', simulateWhatsAppMessage);\n  \n  // Para pruebas, podemos simular un mensaje después de 5 segundos\n  /*\n  setTimeout(() => {\n    simulateWhatsAppMessage(`\n      *NUEVA RESERVA DE MESA*\n      ---------------------------\n      *Nombre:* Juan Pérez\n      *Teléfono móvil:* 123456789\n      *Email:* juan@example.com\n      *Fecha:* 2023-05-15\n      *Hora:* 20:30\n      *Personas:* 4\n      *Notas:* Mesa cerca de la ventana\n      ---------------------------\n    `);\n  }, 5000);\n  */\n});\n\n// Limpiar listeners al desmontar\nonUnmounted(() => {\n  console.log('WhatsAppReservationHandler desmontado');\n  eventBus.off('whatsapp-message', simulateWhatsAppMessage);\n});\n\n// Exponer funciones para uso externo\ndefineExpose({\n  processWhatsAppMessage,\n  simulateWhatsAppMessage\n});\n</script>\n"],"mappings":";;uBAAAA,mBAAA,CAAAC,SAAA,SACEC,mBAAA,2EAA8E,E,0BAC9EC,mBAAA,CAEM;IAFDC,KAAsB,EAAtB;MAAA;IAAA;EAAsB,IACzBD,mBAAA,CAA+C,WAA5C,0CAAwC,E","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}